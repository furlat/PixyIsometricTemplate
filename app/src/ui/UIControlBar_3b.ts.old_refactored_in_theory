import { StorePanel_3b } from './StorePanel_3b'
import { GeometryPanel_3b } from './GeometryPanel_3b'
import { ObjectEditPanel_3b } from './ObjectEditPanel'
import { gameStore_3b, gameStore_3b_methods } from '../store/gameStore_3b'
import { subscribe } from 'valtio'

/**
 * Phase 3A UI Control Bar
 * 
 * Simplified control bar with only essential Phase 3A buttons:
 * - Store panel toggle
 * - Layer toggle bar
 * - Keyboard shortcuts (F1, F2)
 * 
 * Complete isolation from old system - only uses gameStore_3b
 */
export class UIControlBar_3b {
  private storePanel: StorePanel_3b | null = null
  private geometryPanel: GeometryPanel_3b | null = null
  private layerToggleBar: { toggle: () => void; isVisible: () => boolean } | null = null
  private objectEditPanel: ObjectEditPanel_3b | null = null
  
  constructor() {
    this.setupEventListeners()
    this.setupKeyboardShortcuts()
    this.setupSelectionSubscription()
    console.log('UIControlBar_3b: Initialized Phase 3A control bar')
  }
  
  /**
   * Setup event listeners for control bar buttons
   */
  private setupEventListeners(): void {
    // Geometry panel toggle button
    const geometryPanelToggle = document.getElementById('toggle-geometry-panel')
    if (geometryPanelToggle) {
      geometryPanelToggle.addEventListener('click', () => {
        this.toggleGeometryPanel()
      })
    } else {
      console.warn('UIControlBar_3b: Geometry panel toggle button not found')
    }
    
    // Store panel toggle button
    const storePanelToggle = document.getElementById('toggle-store-panel')
    if (storePanelToggle) {
      storePanelToggle.addEventListener('click', () => {
        this.toggleStorePanel()
      })
    } else {
      console.warn('UIControlBar_3b: Store panel toggle button not found')
    }
    
    // Layer toggle bar button
    const layerToggle = document.getElementById('toggle-layers')
    if (layerToggle) {
      layerToggle.addEventListener('click', () => {
        this.toggleLayerBar()
      })
    } else {
      console.warn('UIControlBar_3b: Layer toggle button not found')
    }
  }
  
  /**
   * Setup keyboard shortcuts for Phase 3B
   */
  private setupKeyboardShortcuts(): void {
    document.addEventListener('keydown', (event) => {
      if (event.key === 'F1') {
        this.toggleStorePanel()
        event.preventDefault()
      }
      if (event.key === 'F2') {
        this.toggleLayerBar()
        event.preventDefault()
      }
      if (event.key === 'F3') {
        this.toggleGeometryPanel()
        event.preventDefault()
      }
    })
  }
  
  /**
   * Setup selection subscription for object edit panel
   */
  private setupSelectionSubscription(): void {
    console.log('ðŸ” UIControlBar_3b: Setting up selection subscription...')
    
    subscribe(gameStore_3b.selection, () => {
      console.log('ðŸ” UIControlBar_3b: Selection changed!')
      console.log('ðŸ” Selected object ID:', gameStore_3b.selection.selectedObjectId)
      console.log('ðŸ” Current panel instance:', this.objectEditPanel ? 'EXISTS' : 'NULL')
      
      if (gameStore_3b.selection.selectedObjectId) {
        // Object selected - show edit panel
        console.log('âœ… UIControlBar_3b: Object selected - creating panel...')
        if (!this.objectEditPanel) {
          console.log('âœ… UIControlBar_3b: Creating new ObjectEditPanel_3b instance...')
          try {
            this.objectEditPanel = new ObjectEditPanel_3b()
            console.log('âœ… UIControlBar_3b: ObjectEditPanel_3b created successfully!')
          } catch (error) {
            console.error('âŒ UIControlBar_3b: Error creating ObjectEditPanel_3b:', error)
          }
        } else {
          console.log('âœ… UIControlBar_3b: Panel already exists, reusing instance')
        }
      } else {
        // No object selected - hide edit panel
        console.log('âŒ UIControlBar_3b: No object selected - destroying panel...')
        if (this.objectEditPanel) {
          console.log('âŒ UIControlBar_3b: Destroying ObjectEditPanel_3b instance...')
          this.objectEditPanel.destroy()
          this.objectEditPanel = null
          console.log('âŒ UIControlBar_3b: ObjectEditPanel_3b destroyed')
        }
      }
    })
    
    console.log('âœ… UIControlBar_3b: Selection subscription setup complete')
  }
  
  /**
   * Register store panel with the control bar
   */
  public registerStorePanel(storePanel: StorePanel_3b): void {
    this.storePanel = storePanel
    this.updateStorePanelButton()
    console.log('UIControlBar_3b: Registered store panel')
  }
  
  /**
   * Register geometry panel with the control bar
   */
  public registerGeometryPanel(geometryPanel: GeometryPanel_3b): void {
    this.geometryPanel = geometryPanel
    this.updateGeometryPanelButton()
    console.log('UIControlBar_3b: Registered geometry panel')
  }
  
  /**
   * Register layer toggle bar with the control bar
   */
  public registerLayerToggleBar(layerToggleBar: { toggle: () => void; isVisible: () => boolean }): void {
    this.layerToggleBar = layerToggleBar
    this.updateLayerToggleButton()
    console.log('UIControlBar_3b: Registered layer toggle bar')
  }
  
  /**
   * Toggle store panel visibility
   */
  private toggleStorePanel(): void {
    gameStore_3b_methods.toggleStorePanel()
    this.updateStorePanelButton()
    
    // StorePanel_3b handles its own DOM updates via subscription
    console.log(`UIControlBar_3b: Store panel ${gameStore_3b.ui.showStorePanel ? 'shown' : 'hidden'}`)
  }
  
  /**
   * Toggle geometry panel visibility
   */
  private toggleGeometryPanel(): void {
    gameStore_3b_methods.toggleGeometryPanel()
    this.updateGeometryPanelButton()
    
    // Update DOM visibility
    const geometryPanel = document.getElementById('geometry-panel')
    if (geometryPanel) {
      geometryPanel.style.display = gameStore_3b.ui.showGeometryPanel ? 'block' : 'none'
    }
    
    console.log(`UIControlBar_3b: Geometry panel ${gameStore_3b.ui.showGeometryPanel ? 'shown' : 'hidden'}`)
  }
  
  /**
   * Toggle layer toggle bar visibility
   */
  private toggleLayerBar(): void {
    gameStore_3b_methods.toggleLayerToggle()
    this.updateLayerToggleButton()
    
    // Update DOM visibility
    const toggleBar = document.getElementById('layer-toggle-bar')
    if (toggleBar) {
      toggleBar.style.display = gameStore_3b.ui.showLayerToggle ? 'block' : 'none'
    }
    
    console.log(`UIControlBar_3b: Layer toggle bar ${gameStore_3b.ui.showLayerToggle ? 'shown' : 'hidden'}`)
  }
  
  /**
   * Update store panel button visual state
   */
  private updateStorePanelButton(): void {
    const button = document.getElementById('toggle-store-panel')
    if (button) {
      const isVisible = gameStore_3b.ui.showStorePanel
      
      // Update button appearance
      if (isVisible) {
        button.classList.remove('btn-outline')
        button.classList.add('btn-primary')
      } else {
        button.classList.remove('btn-primary')
        button.classList.add('btn-outline')
      }
      
      // Update button text
      const buttonText = button.querySelector('.button-text')
      if (buttonText) {
        buttonText.textContent = 'Store'
      }
      
      // Update tooltip
      button.title = `${isVisible ? 'Hide' : 'Show'} Store Panel (F1)`
    }
  }
  
  /**
   * Update geometry panel button visual state
   */
  private updateGeometryPanelButton(): void {
    const button = document.getElementById('toggle-geometry-panel')
    if (button) {
      const isVisible = gameStore_3b.ui.showGeometryPanel
      
      // Update button appearance
      if (isVisible) {
        button.classList.remove('btn-outline')
        button.classList.add('btn-success')
      } else {
        button.classList.remove('btn-success')
        button.classList.add('btn-outline')
      }
      
      // Update button text
      const buttonText = button.querySelector('.button-text')
      if (buttonText) {
        buttonText.textContent = 'Geometry'
      }
      
      // Update tooltip
      button.title = `${isVisible ? 'Hide' : 'Show'} Geometry Panel (F3)`
    }
  }
  
  /**
   * Update layer toggle button visual state
   */
  private updateLayerToggleButton(): void {
    const button = document.getElementById('toggle-layers')
    if (button) {
      const isVisible = gameStore_3b.ui.showLayerToggle
      
      // Update button appearance
      if (isVisible) {
        button.classList.remove('btn-outline')
        button.classList.add('btn-warning')
      } else {
        button.classList.remove('btn-warning')
        button.classList.add('btn-outline')
      }
      
      // Update button text
      const buttonText = button.querySelector('.button-text')
      if (buttonText) {
        buttonText.textContent = 'Layers'
      }
      
      // Update tooltip
      button.title = `${isVisible ? 'Hide' : 'Show'} Layer Controls (F2)`
    }
  }
  
  /**
   * Update all button states
   */
  public updateAllButtonStates(): void {
    this.updateGeometryPanelButton()
    this.updateStorePanelButton()
    this.updateLayerToggleButton()
  }
  
  /**
   * Get current state for debugging
   */
  public getDebugInfo(): any {
    return {
      geometryPanel: {
        registered: this.geometryPanel !== null,
        visible: gameStore_3b.ui.showGeometryPanel
      },
      storePanel: {
        registered: this.storePanel !== null,
        visible: gameStore_3b.ui.showStorePanel
      },
      layerToggleBar: {
        registered: this.layerToggleBar !== null,
        visible: gameStore_3b.ui.showLayerToggle
      }
    }
  }
  
  /**
   * Cleanup method
   */
  public destroy(): void {
    // Clean up event listeners if needed
    console.log('UIControlBar_3b: Destroyed')
  }
}